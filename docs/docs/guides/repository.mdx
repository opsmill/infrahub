---
title: Adding/updating external repositories
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# External repositories

Infrahub supports two different types of connections to external Git repositories:

- [**CoreRepository**](/topics/repository#core-repository) fully integrates with Git version control, including branch tracking and two-way branch synchronization.
- [**Read-only Repository**](/topics/repository#read-only-repository) links a particular branch in Infrahub to a particular ref in the Git repository. It will only read from the Git repository. It will never make any changes to the external repository.

## GitHub personal access token {#personal-access-token}

<details>
  <summary>Generate a GitHub fine-grained personal access token</summary>

  1. Go to settings > Developer Settings > Personal access tokens [New GitHub token](https://github.com/settings/personal-access-tokens/new)
  2. Select Fine-grained tokens
  3. Limit the scope of the token in **Repository Access** > **Only Select Repositories**
  4. Grant the token permission:

    - a. If you want to create a CoreRepository using this token, then you will need to give it `Read/Write` access for the **Content** of the repository.
    - b. If you want to create a Read-only Repository using this token, then you will only need to give it `Read` access for the **Content** of the repository.

  ![Fine-Grained Token](../media/github_fined_grain_access_token_setup.png)
</details>

## Adding a repository {#add-repository}

You will need to submit an access token with your request to create a repository in Infrahub. Infrahub uses your username and this token to connect to the external Git repository.

- [Via the web interface](#via-the-web-interface)
- [Via the GraphQL interface](#via-the-graphql-interface)

### Via the web interface

![Add a Git Repository ](../media/create_repository.png)

1. Log in to the Infrahub UI
2. Go to `Unified Storage` > `Repository` or `Read-only Repository`
3. Click on the `+` plus sign
4. Complete the required information:

<Tabs>
  <TabItem value="Default branch">
    **CoreRepository only:** First branch to import during initialization. All other branches on the repository will be imported in a background task after this one.
  </TabItem>
  <TabItem value="Commit">
    (Optional): This field will be populated with the hash of the commit that the Infrahub Repository is currently using once it has pulled the data from the external repository.
    - **CoreRepository**: Ignored during creation and will be overwritten.
    - **Read-only Repository**: Can be used to point at a specific commit within the given `ref`. For example, if you want to extract data from a specific commit on the `main` branch of the external repository other than the latest commit.
  </TabItem>
  <TabItem value="Name" default>
    The name you want to give the repository in Infrahub for identification purposes.
  </TabItem>
  <TabItem value="Description">
    (Optional): A description or comment about the repository used for informational purposes.
  </TabItem>
  <TabItem value="Location">
    The URL of the external repository, for example `https://github.com/opsmill/infrahub.git`.
  </TabItem>
  <TabItem value="Username">
    Your username on the external Git provider.
  </TabItem>
  <TabItem value="Password">
    The password or Fine-grained personal access token with access to the Git repository specified in `Location`.
  </TabItem>
  <TabItem value="Tags">
    (Optional): Assign any tags to be associated with the repository.
  </TabItem>
</Tabs>

:::success Validate that everything is correct

In the UI, you should see your new repository. Click on the row for the repository to see more detailed information. If the repository you added doesn't have the `Commit` property populated it means that the initial sync didn't work. Verify the location and credentials.

:::

### Via the GraphQL interface

Using the GraphQL Interface, it is possible to add a CoreRepository or Read-only Repository via a [Mutation](/topics/graphql).

:::info

If you are using GitHub as your Git Server, you need to have a [fine-grained personal access token](#personal-access-token) to be able to access the repository.

:::

1. Open the [GraphQL Interface](http://localhost:8000/graphql).
2. Add your [authentication token](/topics/auth) with the `Headers`
3. Copy-paste the correct mutation from below and complete the information

<Tabs>
  <TabItem value="CoreRepository" default>

    ```GraphQL
      # Endpoint: http://127.0.0.1:8000/graphql/main
      mutation {
        CoreRepositoryCreate(
          data: {
            name: { value: "YOUR_REPOSITORY_NAME" }
            location: { value: "https://GIT_SERVER/YOUR_GIT_USERNAME/YOUR_REPOSITORY_NAME.git" }
            username: { value: "YOUR_GIT_USERNAME" }
            password: { value: "YOUR_PERSONAL_ACCESS_TOKEN" }
            # default_branch: { value: "main" } <-- optional
          }
        ) {
          ok
          object {
            id
          }
        }
      }
    ```
  </TabItem>
  <TabItem value="Read-only Repository">
    **Make sure that you are on the correct Infrahub branch.** Unlike a CoreRepository, a Read-only Repository will only pull files into the Infrahub branch on which it was created.

    ```GraphQL
      # Endpoint : http://127.0.0.1:8000/graphql/<branch>
      mutation {
        CoreReadOnlyRepositoryCreate(
          data: {
            name: { value: "YOUR_REPOSITORY_NAME" }
            location: { value: "https://GIT_SERVER/YOUR_GIT_USERNAME/YOUR_REPOSITORY_NAME.git" }
            username: { value: "YOUR_GIT_USERNAME" }
            password: { value: "YOUR_PERSONAL_ACCESS_TOKEN" }
            ref: { value: "BRANCH/TAG/COMMIT TO TRACK" }
          }
        ) {
          ok
          object {
            id
          }
        }
      }
    ```
  </TabItem>
</Tabs>

:::success Validate that everything is correct

In the UI, new objects that have been imported from the Git Repository should now be available:

The repository should be visible under [Unified Storage / Repository](http://localhost:8000/objects/CoreRepository/) or [Unified Storage / Read-only Repository](http://localhost:8000/objects/CoreReadOnlyRepository/) depending on which type of repository you created. If the repository you added doesn't have the commit property populated, then it means that the initial sync didn't work. Verify the location and credentials.

:::

## Updates from the external repository

Read-only repositories and CoreRepositories work in different ways when it comes to tracking changes on the remote repository.

### CoreRepository

The [Infrahub Git agent](/reference/git-agent) checks for changes in external repositories several times per minute. If there are no conflicts between the remote and the Infrahub branches, the Git agent will automatically pull any new changes into the appropriate Infrahub branch.

<!-- vale off -->
### Read-only Repository
<!-- vale on -->

Infrahub does not automatically update Read-only Repositories with changes on the external repository. To pull in changes from the external repository you must either set the `ref` **and/or** `commit` of the Read-only Repository to the desired value. You can perform this update either through the user interface or via an update mutation through the GraphQL API. Either way, the Infrahub web server will use the Git agent to retrieve the appropriate changes in a background task.

<details>
  <summary>Example update mutation</summary>

    ```GraphQL
      # Endpoint : http://127.0.0.1:8000/graphql/main
      mutation {
        CoreReadOnlyRepositoryUpdate(
          data: {
            id: "ID_OF_THE_REPOSITORY"
            ref: { value: "BRANCH/TAG/COMMIT TO TRACK" }
            commit: { value: "NEW COMMIT ON THE REF TO PULL" }
          }
        ) {
          ok
          object {
            id
          }
        }
      }
    ```
</details>

## Updates to the external repository

### CoreRepository

When a [Proposed Change](/topics/proposed-change) is merged, if the source and destination Infrahub branches are both linked to branches on the same external Git repository, then Infrahub will handle merging the branches on the external Git repository. This is the only time that Infrahub will push changes to the external repository. Other changes made within Infrahub will not be pushed to an external repository and **could potentially be overwritten** when Infrahub pulls new commits from the external repository.

<!-- vale off -->
### Read-only Repository
<!-- vale on -->

No changes to objects owned by a Read-only Repository are ever pushed to the external Git repository.

## Installing custom CA certificates

If the git server hosting your external git repository is using a server certificate that is signed by a certificate authority that is not part of trust store, then you will have to add the CA certificate using the following process.

:::info

In this process we will have to build a custom docker image. This docker image will have to be rebuild every time you want to use a new release.

:::

First you will have to gather the CA certificate (and any intermediate CA certificates) in PEM format and store it on you local disk.
This guide makes the assumption that you have saved the CA certificate file as `mycacertificate.crt`

Next we will have to create a Dockerfile. The file should be saved as `Dockerfile` in the same directory as the directory containing the CA certificate you want to install.

    ```dockerfile
    ARG INFRAHUB_VERSION=0.15.3
    FROM registry.opsmill.io/opsmill/infrahub:${INFRAHUB_VERSION}
    
    COPY mycacertificate.crt /usr/local/share/ca-certificates/
    RUN update-ca-certificates
    ```

We then have to build a Docker image from the Dockerfile. We can do this by executing this command

    ```bash
    INFRAHUB_VERSION=0.15.3 && docker build --build-arg INFRAHUB_VERSION=$INFRAHUB_VERSION -f Dockerfile -t custom/infrahub:${INFRAHUB_VERSION}
    ```

This will build a custom docker image and tag it as `custom/infrahub:0.15.3`. You can change the version by changing the version we set in the `INFRAHUB_VERSION` shell variable and you can change the tag to you own preference.

As a last step we have to create a `docker-compose.override.yml` file with the following contents in the `development` directory of your clone of the Infrahub repository.

    ```yaml
    ---
    services:
      infrahub-git:
        image: custom/infrahub:0.15.3
    ```

A development environment can then be spun up with `invoke demo.start` command as, explained in the [Installing Infrahub guide](/guides/installation).

## Disable certificate verification

You can disable certificate verification for the external Git repository by following the following process.

:::warning

Disabling certificate validation is a BAD practice and is STRONGLY discouraged

:::

:::info

In this process we will have to build a custom docker image. This docker image will have to be rebuild every time you want to use a new release.

:::

We will have to create a Dockerfile, that should be saved as `Dockerfile` on your local filesystem.

    ```dockerfile
    ARG INFRAHUB_VERSION=0.15.3
    FROM registry.opsmill.io/opsmill/infrahub:${INFRAHUB_VERSION}
    
    RUN git config --global http.sslVerify "false"
    ```

We then have to build a Docker image from the Dockerfile. We can do this by executing this command

    ```bash
    INFRAHUB_VERSION=0.15.3 && docker build --build-arg INFRAHUB_VERSION=$INFRAHUB_VERSION -f Dockerfile -t custom/infrahub:${INFRAHUB_VERSION}
    ```

This will build a custom docker image and tag it as `custom/infrahub:0.15.3`. You can change the version by changing the version we set in the `INFRAHUB_VERSION` shell variable and you can change the tag to you own preference.

As a last step we have to create a `docker-compose.override.yml` file with the following contents in the `development` directory of your clone of the Infrahub repository.

    ```yaml
    ---
    services:
      infrahub-git:
        image: custom/infrahub:0.15.3
    ```

A development environment can then be spun up with `invoke demo.start` command as, explained in the [Installing Infrahub guide](/guides/installation).

## Using a proxy server

In some scenarios Infrahub's git worker containers are not allowed to connect directly to the git server hosting your repository and the connection has to pass through a proxy server.

:::info

This way of using a proxy server for git repositories only works when using HTTP(S) connections. SSH connections are not supported.

:::

:::info

In this process we will have to build a custom docker image. This docker image will have to be rebuild every time you want to use a new release.

:::

We will have to create a Dockerfile, that should be saved as `Dockerfile` on your local filesystem. In the Dockerfile you will have to adapt the URL for the proxy to your environment. Replace `user:password` with the username and password you have to use for the proxy, if required. Replace the FQDN `internal.proxy` to the FQDN of the proxy and modify the port, if required.

    ```dockerfile
    ARG INFRAHUB_VERSION=0.15.3
    FROM registry.opsmill.io/opsmill/infrahub:${INFRAHUB_VERSION}

    RUN git config --global http.proxy http://user:password@internal.proxy:8080
    ```

We then have to build a Docker image from the Dockerfile. We can do this by executing this command

    ```bash
    INFRAHUB_VERSION=0.15.3 && docker build --build-arg INFRAHUB_VERSION=$INFRAHUB_VERSION -f Dockerfile -t custom/infrahub:${INFRAHUB_VERSION}
    ```

This will build a custom docker image and tag it as `custom/infrahub:0.15.3`. You can change the version by changing the version we set in the `INFRAHUB_VERSION` shell variable and you can change the tag to you own preference.

As a last step we have to create a `docker-compose.override.yml` file with the following contents in the `development` directory of your clone of the Infrahub repository.

    ```yaml
    ---
    services:
      infrahub-git:
        image: custom/infrahub:0.15.3
    ```

A development environment can then be spun up with `invoke demo.start` command as, explained in the [Installing Infrahub guide](/guides/installation).
