---
# yamllint disable rule:truthy
name: New Release

on:
  push:
    tags:
      - '*'

jobs:
  meta_data:
    runs-on: ubuntu-22.04
    outputs:
      tags: ${{ steps.meta.outputs.tags }}
      labels: ${{ steps.meta.outputs.labels }}
    steps:
      - name: Set docker image meta data
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY_IMAGE }}
          tags: |
            type=ref,value=${{ inputs.version }}
            type=semver,pattern={{version}},value=${{ github.ref_name }}
            type=semver,pattern={{major}}.{{minor}},value=${{ github.ref_name }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.version=${{ github.ref_name }}
            org.opencontainers.image.created=${{ steps.meta.outputs.created }}
          flavor: |
            latest=false

  publish-docker-image:
    uses: ./.github/workflows/ci-docker-image.yml
    secrets: inherit
    with:
      publish: true
      version: ${{ github.ref_name }}
      ref: ${{ github.sha }}
      tags: ${{ needs.meta_data.outputs.tags }}
      labels: ${{ needs.meta_data.outputs.labels }}
